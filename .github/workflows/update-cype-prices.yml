name: Update CYPE Prices Monthly

on:
  # Run on 1st of every month at 2 AM UTC
  schedule:
    - cron: "0 2 1 * *"

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      categories:
        description: "Categories to scrape (comma-separated)"
        required: false
        default: "all"

jobs:
  scrape-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 720 # 12 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Setup ProtonVPN (optional)
        run: |
          # Install ProtonVPN CLI if needed
          # sudo apt-get update
          # sudo apt-get install -y openvpn
          echo "VPN setup placeholder - configure if needed"

      - name: Run CYPE Scraper
        env:
          SCRAPE_REGION: "Lisboa"
        run: |
          echo "üöÄ Starting CYPE price scraping..."
          npx tsx scripts/scrape-with-breakdown.ts
        continue-on-error: true

      - name: Upload to Supabase
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üì§ Uploading to Supabase..."
          npx tsx scripts/upload-to-supabase.ts data/cype-breakdown.json Lisboa

      - name: Commit and push JSON backup
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Create backup with date
          DATE=$(date +%Y-%m-%d)
          mkdir -p data/backups
          cp data/cype-breakdown.json data/backups/cype-prices-$DATE.json

          # Commit if changes exist
          git add data/cype-breakdown.json data/backups/
          git diff --quiet && git diff --staged --quiet || git commit -m "chore: update CYPE prices - $DATE"
          git push
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cype-${{ github.run_number }}
          name: CYPE Prices Update ${{ github.run_number }}
          body: |
            Automated CYPE prices update for Lisboa/Cascais region

            **Date:** ${{ github.run_date }}
            **Source:** geradordeprecos.info
            **Region:** Lisboa

            See attached JSON files for full price database.
          files: |
            data/cype-breakdown.json
            data/cype-breakdown.csv
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå CYPE price update failed!"
          # Add notification webhook here (Slack, Discord, email, etc.)
